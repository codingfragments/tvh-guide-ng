services:
  epg-cache:
    build:
      context: ..
      dockerfile: docker/epg-cache/Dockerfile
    image: ${IMAGE_REGISTRY:-}tvh-guide-epg-cache:${IMAGE_TAG:-latest}
    ports:
      - "3100:3000"
    environment:
      - TVH_URL=${TVH_URL:?Set TVH_URL to your TVHeadend instance (e.g. http://192.168.1.10:9981)}
      - TVH_USERNAME=${TVH_USERNAME:-}
      - TVH_PASSWORD=${TVH_PASSWORD:-}
      - EPG_REFRESH_INTERVAL=${EPG_REFRESH_INTERVAL:-3600}
      - EPG_SQLITE_PATH=/data/epg-cache.db
      # - PICON_PATH=/picons
    volumes:
      - epg-data:/data
      # Uncomment to serve picon images from a local directory:
      # - /path/to/picons:/picons:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/api/channels').then(r => { if (!r.ok) process.exit(1) })"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  web:
    build:
      context: ..
      dockerfile: docker/web/Dockerfile
      args:
        PUBLIC_EPG_CACHE_URL: ${PUBLIC_EPG_CACHE_URL:-http://epg-cache:3000}
    image: ${IMAGE_REGISTRY:-}tvh-guide-web:${IMAGE_TAG:-latest}
    ports:
      - "8080:3000"
    depends_on:
      epg-cache:
        condition: service_healthy
    restart: unless-stopped

volumes:
  epg-data:
