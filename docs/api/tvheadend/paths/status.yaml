# Status and monitoring API endpoints

/api/status/connections:
  get:
    summary: List active connections
    description: |
      Get all active client connections and subscriptions.

      **Common Use Cases:**
      - Monitor active streams
      - See who's watching what
      - Troubleshoot connection issues
    operationId: getConnections
    tags:
      - Status
    security:
      - BasicAuth: []
    responses:
      '200':
        description: Active connections list
        content:
          application/json:
            schema:
              type: object
              properties:
                entries:
                  type: array
                  items:
                    $ref: '../components/schemas/status.yaml#/ConnectionStatus'
            example:
              entries:
                - id: 1
                  type: 'HTSP'
                  peer: '192.168.1.100'
                  user: 'client1'
                  started: 1704067200
                  channel: 'BBC One HD'
                  input: 104857600
                  output: 104857600
      '401':
        $ref: '../components/responses/errors.yaml#/Unauthorized'
      '403':
        $ref: '../components/responses/errors.yaml#/Forbidden'

/api/status/inputs:
  get:
    summary: Get input/adapter status
    description: |
      Get status of all TV input adapters/tuners.

      **Common Use Cases:**
      - Monitor signal quality
      - Check tuner availability
      - Troubleshoot reception issues
    operationId: getInputs
    tags:
      - Status
    security:
      - BasicAuth: []
    responses:
      '200':
        description: Input adapters status
        content:
          application/json:
            schema:
              type: object
              properties:
                entries:
                  type: array
                  items:
                    $ref: '../components/schemas/status.yaml#/InputStatus'
            example:
              entries:
                - uuid: '550e8400-e29b-41d4-a716-446655440040'
                  type: 'DVB-T'
                  name: '/dev/dvb/adapter0'
                  active: false
                  signal: 90
                  snr: 85
                  ber: 0
                  unc: 0
                  subscribers: 0
      '401':
        $ref: '../components/responses/errors.yaml#/Unauthorized'

/api/service/grid:
  get:
    summary: List services
    description: |
      Get all TV services (underlying broadcast streams that channels map to).

      **Common Use Cases:**
      - View all available services
      - Check service quality
      - Debug channel mapping issues
    operationId: getServiceGrid
    tags:
      - Status
    security:
      - BasicAuth: []
    parameters:
      - $ref: '../components/parameters/pagination.yaml#/StartParameter'
      - $ref: '../components/parameters/pagination.yaml#/LimitParameter'
      - $ref: '../components/parameters/pagination.yaml#/SortParameter'
      - $ref: '../components/parameters/pagination.yaml#/DirParameter'
    responses:
      '200':
        description: Services list
        content:
          application/json:
            schema:
              allOf:
                - $ref: '../components/schemas/grid.yaml#/GridResponse'
                - type: object
                  properties:
                    entries:
                      type: array
                      items:
                        $ref: '../components/schemas/status.yaml#/ServiceStatus'
            example:
              entries:
                - uuid: '550e8400-e29b-41d4-a716-446655440041'
                  enabled: true
                  type: 'DVB-T'
                  network: 'Freeview'
                  mux: '626MHz'
                  svcname: 'BBC One HD'
                  quality: 95
              total: 1
      '401':
        $ref: '../components/responses/errors.yaml#/Unauthorized'

/api/log:
  get:
    summary: Get system logs
    description: |
      Retrieve recent system log entries.

      **Common Use Cases:**
      - Troubleshoot errors
      - Monitor EPG grabbing
      - Debug recording issues
    operationId: getLog
    tags:
      - Status
    security:
      - BasicAuth: []
    parameters:
      - name: start
        in: query
        description: Starting offset
        schema:
          type: integer
          default: 0
      - name: limit
        in: query
        description: Maximum entries
        schema:
          type: integer
          default: 50
      - name: level
        in: query
        description: Minimum log level
        schema:
          type: string
          enum: [DEBUG, INFO, WARNING, ERROR, ALERT]
          default: INFO
    responses:
      '200':
        description: Log entries
        content:
          application/json:
            schema:
              type: object
              properties:
                entries:
                  type: array
                  items:
                    $ref: '../components/schemas/status.yaml#/SystemLog'
                total:
                  type: integer
            example:
              entries:
                - time: 1704067200
                  severity: 'INFO'
                  subsystem: 'epggrab'
                  message: 'EPG grabbing completed successfully'
              total: 1
      '401':
        $ref: '../components/responses/errors.yaml#/Unauthorized'
      '403':
        $ref: '../components/responses/errors.yaml#/Forbidden'

/api/status/subscriptions:
  get:
    summary: List active subscriptions
    description: |
      Get all active streaming subscriptions (channels being watched).

      **Common Use Cases:**
      - Monitor what channels are currently being streamed
      - View subscription details
      - Check tuner usage
    operationId: getSubscriptions
    tags:
      - Status
    security:
      - BasicAuth: []
    responses:
      '200':
        description: Active subscriptions list
        content:
          application/json:
            schema:
              type: object
              properties:
                entries:
                  type: array
                  items:
                    $ref: '../components/schemas/status.yaml#/SubscriptionStatus'
            example:
              entries:
                - id: 1
                  channel: 'BBC One HD'
                  service: 'DVB-T Service'
                  profile: 'htsp'
                  username: 'client1'
                  start: 1704067200
                  weight: 100
      '401':
        $ref: '../components/responses/errors.yaml#/Unauthorized'
      '403':
        $ref: '../components/responses/errors.yaml#/Forbidden'

/api/status/activity:
  get:
    summary: Get activity status for low-power mode
    description: |
      Get server activity status to determine if the system can enter low-power mode.

      **Requirements:**
      - TVHeadend version 4.3-2405 or later

      **Common Use Cases:**
      - Check if recordings are in progress
      - Determine if server can be put to sleep
      - Monitor system activity
    operationId: getActivityStatus
    tags:
      - Status
    security:
      - BasicAuth: []
    responses:
      '200':
        description: Activity status
        content:
          application/json:
            schema:
              type: object
              properties:
                entries:
                  type: array
                  items:
                    $ref: '../components/schemas/status.yaml#/ActivityStatus'
            example:
              entries:
                - activity: 'recording'
                  description: 'Recording in progress'
                  canSleep: false
      '401':
        $ref: '../components/responses/errors.yaml#/Unauthorized'
      '403':
        $ref: '../components/responses/errors.yaml#/Forbidden'

/api/status/inputclrstats:
  post:
    summary: Reset input device counters
    description: |
      Reset statistics counters for input devices (tuners/adapters).

      **Common Use Cases:**
      - Clear signal quality statistics
      - Reset error counters
      - Start fresh monitoring period
    operationId: clearInputStats
    tags:
      - Status
    security:
      - BasicAuth: []
    requestBody:
      required: false
      content:
        application/json:
          schema:
            type: object
            properties:
              uuid:
                type: string
                description: Optional input UUID to reset (empty = reset all)
          example:
            uuid: 'adapter-uuid-123'
    responses:
      '200':
        description: Statistics cleared successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
              example:
                success: true
      '401':
        $ref: '../components/responses/errors.yaml#/Unauthorized'
      '403':
        $ref: '../components/responses/errors.yaml#/Forbidden'

/api/connections/cancel:
  post:
    summary: Disconnect client connections
    description: |
      Forcibly disconnect client connections.
      Requires admin privileges.

      **Common Use Cases:**
      - Kick idle clients
      - Force disconnect misbehaving clients
      - Free up connection slots
    operationId: cancelConnections
    tags:
      - Status
    security:
      - BasicAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              id:
                type: integer
                description: Connection ID to disconnect
            required:
              - id
          example:
            id: 1
    responses:
      '200':
        description: Connection cancelled successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
              example:
                success: true
      '400':
        $ref: '../components/responses/errors.yaml#/BadRequest'
      '401':
        $ref: '../components/responses/errors.yaml#/Unauthorized'
      '403':
        $ref: '../components/responses/errors.yaml#/Forbidden'
      '404':
        $ref: '../components/responses/errors.yaml#/NotFound'
